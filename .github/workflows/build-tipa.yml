name: 构建 Bootstrap TIPA (RootHide)
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: 拉取仓库代码（强制递归所有子模块）
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          persist-credentials: false

      - name: 修复 basebin 子模块缺失（核心）
        run: |
          # 初始化并更新 basebin 子模块（解决 commlib.h 缺失）
          cd $GITHUB_WORKSPACE
          git submodule init basebin || true
          git submodule update --recursive --remote basebin || true
          
          # 编译 basebin 生成 commlib.h 等头文件 + 静态库
          cd basebin/common
          make clean
          make ARCHS=arm64 SDK=iphoneos CC=clang CXX=clang++ || true
          
          # 复制编译后的头文件到工程目录（确保 Xcode 能找到）
          cp -rf $GITHUB_WORKSPACE/basebin/common/include/* $GITHUB_WORKSPACE/Bootstrap/basebin/common/
          cp -rf $GITHUB_WORKSPACE/basebin/common/lib/* $GITHUB_WORKSPACE/Bootstrap/basebin/common/lib/
          
          # 修复 XPC 模块重定义
          sed -i '' 's/module XPC/module CustomXPC/g' $GITHUB_WORKSPACE/basebin/common/xpc/module.modulemap || true

      - name: 手动创建缺失目录（兜底）
        run: |
          # 确保所有依赖目录存在
          mkdir -p $GITHUB_WORKSPACE/Bootstrap/basebin/common/include
          mkdir -p $GITHUB_WORKSPACE/Bootstrap/basebin/common/lib
          # 临时移动 Makefile 避免 Xcode 编译错误
          mv $GITHUB_WORKSPACE/Makefile $GITHUB_WORKSPACE/Makefile.backup

      - name: 安装依赖（Theos + ldid）
        run: |
          brew uninstall --force ldid || true
          curl -LO https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid-macos-x86_64
          chmod +x ldid-macos-x86_64
          sudo mv ldid-macos-x86_64 /usr/local/bin/ldid
          
          git clone --recursive https://github.com/roothide/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "PATH=$HOME/theos/bin:$PATH" >> $GITHUB_ENV
          
          sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          xcodebuild -version
          if command -v ldid &> /dev/null; then
            echo "ldid 安装成功"
          else
            echo "ldid 安装失败"
            exit 1
          fi

      - name: 编译并打包 TIPA（强制指定头文件路径）
        run: |
          cd $GITHUB_WORKSPACE
          mv $GITHUB_WORKSPACE/Makefile.backup $GITHUB_WORKSPACE/Makefile
          make clean
          
          # 核心：指定头文件搜索路径，解决 commlib.h 找不到
          make package \
            Bootstrap_XCODEFLAGS="\
              IPHONEOS_DEPLOYMENT_TARGET=15.0 \
              CODE_SIGN_IDENTITY='' \
              AD_HOC_CODE_SIGNING_ALLOWED=YES \
              CODE_SIGNING_ALLOWED=NO \
              EXCLUDED_SOURCE_FILE_NAMES='Makefile' \
              USER_HEADER_SEARCH_PATHS='$(PROJECT_DIR)/basebin/common/include $(PROJECT_DIR)/Bootstrap/basebin/common/include' \
              LIBRARY_SEARCH_PATHS='$(PROJECT_DIR)/basebin/common/lib $(PROJECT_DIR)/Bootstrap/basebin/common/lib' \
              SWIFT_INCLUDE_PATHS='$(PROJECT_DIR)/basebin/common/include' \
            "

      - name: 上传 TIPA 产物
        uses: actions/upload-artifact@v4
        with:
          name: Bootstrap-TIPA
          path: ${{ github.workspace }}/packages/Bootstrap.tipa
          retention-days: 90
