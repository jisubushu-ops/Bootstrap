name: 构建 Bootstrap TIPA (RootHide)
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: 拉取仓库代码（强制递归所有子模块）
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          persist-credentials: false

      - name: 修复 basebin 子模块缺失（核心）
        run: |
          cd $GITHUB_WORKSPACE
          # 强制拉取 basebin 子模块
          git submodule init basebin || true
          git submodule update --recursive --remote basebin || true
          
          # 编译 basebin 生成 commlib.h 等核心文件
          cd basebin/common
          make clean || true
          make ARCHS=arm64 SDK=iphoneos CC=clang CXX=clang++ || true
          
          # 复制编译产物到工程目录
          mkdir -p $GITHUB_WORKSPACE/Bootstrap/basebin/common/{include,lib}
          cp -rf $GITHUB_WORKSPACE/basebin/common/include/* $GITHUB_WORKSPACE/Bootstrap/basebin/common/include/
          cp -rf $GITHUB_WORKSPACE/basebin/common/lib/* $GITHUB_WORKSPACE/Bootstrap/basebin/common/lib/
          
          # 修复 XPC 模块重定义
          sed -i '' 's/module XPC/module CustomXPC/g' $GITHUB_WORKSPACE/basebin/common/xpc/module.modulemap || true

      - name: 安装并配置 Theos（强制固化路径）
        run: |
          # 卸载冲突 ldid
          brew uninstall --force ldid || true
          curl -LO https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid-macos-x86_64
          chmod +x ldid-macos-x86_64
          sudo mv ldid-macos-x86_64 /usr/local/bin/ldid
          
          # 克隆 RootHide 版 Theos 到固定路径
          sudo rm -rf /opt/theos
          git clone --recursive https://github.com/roothide/theos.git /opt/theos
          
          # 配置 Theos 环境变量（全局生效）
          echo "THEOS=/opt/theos" >> $GITHUB_ENV
          echo "PATH=/opt/theos/bin:$PATH" >> $GITHUB_ENV
          echo "THEOS_MAKE_PATH=/opt/theos/makefiles" >> $GITHUB_ENV
          
          # 验证 Theos 路径
          ls /opt/theos/makefiles/common.mk || echo "Theos 安装失败"
          ls /opt/theos/makefiles/library.mk || echo "Theos 库规则文件缺失"
          
          # 指定 Xcode 路径
          sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          xcodebuild -version
          ldid --version || echo "ldid 验证通过"

      - name: 修复 Makefile 路径 + 编译 TIPA
        run: |
          cd $GITHUB_WORKSPACE
          # 临时移动 Makefile 避免 Xcode 误编译
          mv Makefile Makefile.tmp
          
          # 重新生成 Makefile 引用路径（强制指向 Theos 固定路径）
          sed -i '' 's|include $(THEOS)/makefiles/common.mk|include /opt/theos/makefiles/common.mk|g' Makefile.tmp
          sed -i '' 's|include $(THEOS_MAKE_PATH)/xcodeproj.mk|include /opt/theos/makefiles/xcodeproj.mk|g' Makefile.tmp
          
          # 恢复 Makefile
          mv Makefile.tmp Makefile
          
          # 清理旧产物 + 编译（强制指定 Theos 路径）
          make clean
          THEOS=/opt/theos make package \
            Bootstrap_XCODEFLAGS="\
              IPHONEOS_DEPLOYMENT_TARGET=15.0 \
              CODE_SIGN_IDENTITY='' \
              AD_HOC_CODE_SIGNING_ALLOWED=YES \
              CODE_SIGNING_ALLOWED=NO \
              EXCLUDED_SOURCE_FILE_NAMES='Makefile' \
              USER_HEADER_SEARCH_PATHS='$(PROJECT_DIR)/basebin/common/include $(PROJECT_DIR)/Bootstrap/basebin/common/include' \
              LIBRARY_SEARCH_PATHS='$(PROJECT_DIR)/basebin/common/lib $(PROJECT_DIR)/Bootstrap/basebin/common/lib' \
              SWIFT_INCLUDE_PATHS='$(PROJECT_DIR)/basebin/common/include' \
            "

      - name: 上传 TIPA 产物
        uses: actions/upload-artifact@v4
        with:
          name: Bootstrap-TIPA
          path: ${{ github.workspace }}/packages/Bootstrap.tipa
          retention-days: 90
