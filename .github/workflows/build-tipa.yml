name: 构建 Bootstrap TIPA (RootHide)
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 补全 basebin 子模块并编译
        run: |
          cd $GITHUB_WORKSPACE
          git submodule init basebin
          git submodule update --recursive basebin
          # 编译 basebin 生成静态库
          cd basebin/common
          make clean && make ARCHS=arm64
          cd $GITHUB_WORKSPACE

      - name: 修复 XPC 模块重定义
        run: |
          # 修改 module.modulemap 中的 XPC 模块名为 CustomXPC
          sed -i '' 's/module XPC/module CustomXPC/g' $GITHUB_WORKSPACE/basebin/common/xpc/module.modulemap

      - name: 安装依赖（Theos/ldid）
        run: |
          brew uninstall --force ldid || true
          curl -LO https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid-macos-x86_64
          chmod +x ldid-macos-x86_64
          sudo mv ldid-macos-x86_64 /usr/local/bin/ldid
          git clone --recursive https://github.com/roothide/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "PATH=$HOME/theos/bin:$PATH" >> $GITHUB_ENV
          sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          # 验证依赖
          xcodebuild -version
          if command -v ldid &> /dev/null; then
            echo "ldid 安装成功"
          else
            echo "ldid 安装失败"
            exit 1
          fi

      - name: 编译并打包 TIPA
        run: |
          cd $GITHUB_WORKSPACE
          make clean
          # 传递工程配置参数，强制禁用签名
          make package \
            Bootstrap_XCODEFLAGS="IPHONEOS_DEPLOYMENT_TARGET=15.0 CODE_SIGN_IDENTITY='' AD_HOC_CODE_SIGNING_ALLOWED=YES CODE_SIGNING_ALLOWED=NO"

      - name: 上传 TIPA 产物
        uses: actions/upload-artifact@v4
        with:
          name: Bootstrap-TIPA
          path: ${{ github.workspace }}/packages/Bootstrap.tipa
          retention-days: 90
